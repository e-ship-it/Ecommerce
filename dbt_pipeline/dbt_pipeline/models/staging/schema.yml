version: 2

models:
  - name: hub_users
    description: "This model extracts unique user data from the batch.users table."
    columns:
      - name: user_hkey
        description: "Unique Hash key againt user_id"
        tests:
          - not_null
          - unique
      - name: user_id
        description: "Unique identifier for the user."
        tests:
          - not_null
          - unique
      - name: load_timestamp
        description: "Timestamp of when this record was loaded."
      - name: record_source
        description: "The source from which the data originated."

  - name: hub_product
    description: "Hub table for product data. Stores the product_id (business key) and a surrogate key (product_hkey)."
    columns:
      - name: product_hkey
        description: "Surrogate key generated using MD5 hash of product_id"
        tests:
          - unique
          - not_null
      - name: product_id
        description: "Business key for the product"
        tests:
          - not_null
      - name: load_timestamp
        description: "Timestamp when the record was loaded"
        tests:
          - not_null
      - name: record_source
        description: "Source of the record (e.g., batch.products)"
        tests:
          - not_null        
 

  - name: hub_aisles
    description: "This model extracts unique user data from the batch.users table."
    columns:
      - name: aisle_hkey
        description: "Unique Hash key againt aisle_id"
        tests:
          - not_null
          - unique
      - name: aisle_id
        description: "Unique identifier for the aisle."
        tests:
          - not_null
          - unique
      - name: load_timestamp
        description: "Timestamp of when this record was loaded."
      - name: record_source
        description: "The source from which the data originated."

  - name: hub_departments
    description: "This model extracts unique user data from the batch.users table."
    columns:
      - name: department_hkey
        description: "Unique Hash key againt department_id"
        tests:
          - not_null
          - unique
      - name: department_id
        description: "Unique identifier for the department."
        tests:
          - not_null
          - unique
      - name: load_timestamp
        description: "Timestamp of when this record was loaded."
      - name: record_source
        description: "The source from which the data originated."               

  - name: link_order_product
    description: "This model captures the relationship between orders and products, tracking the unique pairing and associated metadata."
    materialized: incremental
    unique_key: order_product_hkey
    columns:
      - name: order_product_hkey
        description: "A surrogate key for the relationship between order and product."
        tests:
          - not_null
          - unique
      - name: order_hkey
        description: "Business key for the order, derived from the order_id."
        tests:
          - not_null
      - name: product_hkey
        description: "Business key for the product, derived from product_id."
        tests:
          - not_null
      - name: load_timestamp
        description: "Timestamp when the record was loaded or updated."
        tests:
          - not_null
      - name: record_source
        description: "The source from which the record was pulled (e.g., 'streams.user_order_activity_stream')."
        tests:
          - not_null

  - name: link_aisle_department_product
    description: >
      Link table representing the relationship between products, aisles, and departments.
      Built from the batch.products source using hashed surrogate keys.
    columns:
      - name: aisle_department_product_hkey
        description: "Surrogate hash key representing the unique combination of aisle, department, and product."
        tests:
          - not_null
          - unique

      - name: product_hkey
        description: "Hashed key derived from product_id."
        tests:
          - not_null

      - name: aisle_hkey
        description: "Hashed key derived from aisle_id."
        tests:
          - not_null

      - name: department_hkey
        description: "Hashed key derived from department_id."
        tests:
          - not_null

      - name: load_timestamp
        description: "Timestamp indicating when the record was loaded."
        tests:
          - not_null

      - name: record_source
        description: "Static identifier for the record's origin (e.g., batch.products)."
        tests:
          - not_null


  - name: link_order_user
    description: "This model represents the relationship between users and orders, linking user details to their order history."
    materialized: incremental
    unique_key: user_order_hkey
    columns:
      - name: user_order_hkey
        description: "A surrogate hash key for the relationship between user and order."
        tests:
          - not_null
          - unique
      - name: order_hkey
        description: "Business key for the order, derived from order_id."
        tests:
          - not_null
      - name: user_hkey
        description: "Business key for the user, derived from user_id."
        tests:
          - not_null
      - name: load_timestamp
        description: "Timestamp when the record was loaded or updated."
        tests:
          - not_null
      - name: record_source
        description: "The source from which the record was pulled (e.g., 'streams.orders')."
        tests:
          - not_null          

  - name: satellite_user
    description: |
      Incremental model staging user data from the batch.users source.
      Generates surrogate keys and detects changes using hashdiff for incremental loading.
    columns:
      - name: user_hkey
        description: "Hashed surrogate key generated from user_id."
        tests:
          - not_null
          - unique

      - name: user_name
        description: "User's full name."
        tests:
          - not_null

      - name: email
        description: "User's email address."
        tests:
          - not_null

      - name: phone_number
        description: "User's phone number."

      - name: address
        description: "User's address."

      - name: birthdate
        description: "User's date of birth."

      - name: registration_date
        description: "Date when the user registered."

      - name: load_timestamp
        description: "Timestamp when the record was loaded."
        tests:
          - not_null

      - name: hashdiff
        description: "Hash digest representing current state of user record for change detection."
        tests:
          - not_null

  - name: satellite_order
    description: |
      Incremental model staging orders data from the streams.orders source.
      Uses hashed surrogate keys and hashdiff to detect changes for incremental loads.
    columns:
      - name: order_hkey
        description: "Hashed surrogate key generated from order_id."
        tests:
          - not_null
          - unique

      - name: order_number
        description: "Order number."

      - name: order_dow
        description: "Day of week the order was placed."

      - name: order_hour_of_day
        description: "Hour of day the order was placed."

      - name: days_since_prior_order
        description: "Number of days since prior order."

      - name: created_at
        description: "Order creation timestamp."

      - name: updated_at
        description: "Order update timestamp."

      - name: load_timestamp
        description: "Timestamp when the record was loaded."
        tests:
          - not_null

      - name: hashdiff
        description: "Hash digest used for change detection in incremental loads."
        tests:
          - not_null

  - name: satellite_product
    description: |
      Incremental model staging link data between aisle, department, and product.
      Uses hashed surrogate keys and hashdiff for change detection.
    columns:
      - name: aisle_department_product_hkey
        description: "Hashed surrogate key representing the combination of aisle, department, and product IDs."
        tests:
          - not_null
          - unique

      - name: product_name
        description: "Name of the product."

      - name: created_at
        description: "Timestamp when the record was created."
        tests:
          - not_null

      - name: updated_at
        description: "Timestamp when the record was last updated."

      - name: load_timestamp
        description: "Timestamp when the record was loaded into the model."
        tests:
          - not_null

      - name: hashdiff
        description: "Hash digest used to detect changes for incremental loading."
        tests:
          - not_null

  - name: satellite_order_user_order_activity_stream
    description: >
      Staging model for user order activity stream, capturing product-level activity per order.
      Deduplicated based on `order_product_hkey` and `hashdiff`.
    columns:
      - name: order_product_hkey
        description: "Unique hash key generated from order_id and product_id."
        tests:
          - not_null
          - unique

      - name: reordered
        description: "Boolean flag indicating if the product was reordered."

      - name: add_to_cart_order
        description: "Position of the item in the cart."

      - name: created_at
        description: "Timestamp when the activity was created."

      - name: updated_at
        description: "Timestamp when the activity was last updated."

      - name: load_timestamp
        description: "ETL load timestamp used for incremental logic."

      - name: hashdiff
        description: "Hash of selected columns to track changes efficiently."
        tests:
          - not_null